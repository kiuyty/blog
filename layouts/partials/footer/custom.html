{{- /* æ·»åŠ Live2Dçœ‹æ¿å¨˜ - è·¯å¾„ä¿®å¤ç‰ˆ */ -}}
<script>
  (function() {
    const cdnPath = "https://cdn.jsdelivr.net/gh/kiuyty/live2d@main";
    const config = {
      path: {
        homePath: "/",
        modelPath: cdnPath + "/Resources/",
        cssPath: cdnPath + "/css/waifu.css",
        tipsJsonPath: cdnPath + "/Resources/waifu-tips.json",
        tipsJsPath: cdnPath + "/js/waifu-tips.js",
        live2dCorePath: cdnPath + "/Core/live2dcubismcore.js",
        live2dSdkPath: cdnPath + "/js/live2d-sdk.js"
      },
      tools: ["hitokoto", "asteroids", "express", "switch-model", "switch-texture", "photo", "info", "quit"],
      drag: { enable: true, direction: ["x", "y"] },
      switchType: "order"
    };

    console.log('Live2D è·¯å¾„ä¿®å¤ç‰ˆå¯åŠ¨', cdnPath);

    if (screen.width < 768) {
      console.log('ç§»åŠ¨ç«¯ä¸æ˜¾ç¤º');
      return;
    }

    Promise.all([
      loadCSS(config.path.cssPath),
      loadScript(config.path.live2dCorePath),
      loadScript(config.path.live2dSdkPath),
      loadScript(config.path.tipsJsPath).then(() => {
        console.log('waifu-tips.js å·²åŠ è½½');
        return new Promise(resolve => setTimeout(resolve, 300));
      })
    ]).then(() => {
      console.log('æ‰€æœ‰èµ„æºå°±ç»ª...');
      
      return fetch(config.path.modelPath + 'model_list.json')
        .then(r => r.json())
        .then(modelData => {
          console.log('æ¨¡å‹æ•°æ®å·²åŠ è½½:', modelData);
          
          // è°ƒç”¨ initWidget
          if (typeof window.initWidget === 'function') {
            console.log('è°ƒç”¨ initWidget');
            window.initWidget({
              waifuPath: config.path.tipsJsonPath,
              cdnPath: config.path.modelPath,
              tools: config.tools,
              dragEnable: config.drag.enable,
              dragDirection: config.drag.direction,
              switchType: config.switchType,
              modelList: { models: modelData }
            });
          }
          
          // å…³é”®ä¿®å¤ï¼šç¡®ä¿è·¯å¾„æ­£ç¡®
          setTimeout(() => {
            if (window.live2d) {
              // å…ˆåˆå§‹åŒ–ï¼Œè·¯å¾„è¦æ­£ç¡®
              window.live2d.init(config.path.modelPath + 'model/');
              
              // æ„å»ºæ­£ç¡®çš„æ¨¡å‹è·¯å¾„
              // æ³¨æ„ï¼šä¸è¦é‡å¤ model/lafeiï¼Œå› ä¸º init å·²ç»æŒ‡å®šäº† model/ ç›®å½•
              const modelPath = 'lafei/lafei.model3.json';
              console.log('å°è¯•åŠ è½½æ¨¡å‹:', modelPath);
              
              // åŠ è½½æ¨¡å‹
              window.live2d.loadModel(modelPath);
            }
          }, 1000);
          
          console.log('ğŸ‰ åˆå§‹åŒ–å®Œæˆ');
        });
    }).catch(e => console.error('åˆå§‹åŒ–å¤±è´¥:', e));

    function loadCSS(url) {
      return new Promise((resolve, reject) => {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = url;
        link.onload = () => resolve(url);
        link.onerror = reject;
        document.head.appendChild(link);
      });
    }

    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        script.onload = () => resolve(url);
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
  })();
</script>

<style>
  #waifu { right: 0; bottom: 0; left: auto; }
  #waifu-toggle { right: 5px; left: auto; }
</style>
