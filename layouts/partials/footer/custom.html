{{- /* 添加Live2D看板娘 */ -}}
<script>
  const cdnPath = "https://cdn.jsdelivr.net/gh/letere-gzj/live2d-widget-v3@main";
  const config = {
    path: {
      homePath: "/",
      modelPath: cdnPath + "/Resources/",
      cssPath: cdnPath + "/waifu.css",
      tipsJsonPath: cdnPath + "/waifu-tips.json",
      // 修复这个路径 - 删除多余的 @main
      tipsJsPath: cdnPath + "/waifu-tips.js",
      live2dCorePath: cdnPath + "/Core/live2dcubismcore.js",
      live2dSdkPath: cdnPath + "/live2d-sdk.js"
    },
    tools: ["hitokoto", "asteroids", "express", "switch-model", "switch-texture", "photo", "info", "quit"],
    drag: {
      enable: true,
      direction: ["x", "y"]
    },
    switchType: "order"
  }

  // 只在桌面端显示
  if (screen.width >= 768) {
    Promise.all([
      loadExternalResource(config.path.cssPath, "css"),
      loadExternalResource(config.path.live2dCorePath, "js"),
      loadExternalResource(config.path.live2dSdkPath, "js"),
      loadExternalResource(config.path.tipsJsPath, "js")
    ]).then(() => {
      // 检查 initWidget 是否存在
      if (typeof initWidget === 'function') {
        initWidget({
          waifuPath: config.path.tipsJsonPath,
          cdnPath: config.path.modelPath,
          tools: config.tools,
          dragEnable: config.drag.enable,
          dragDirection: config.drag.direction,
          switchType: config.switchType
        });
      } else {
        console.error('initWidget function not found');
      }
    }).catch(error => {
      console.error('Failed to load Live2D resources:', error);
    });
  }

  function loadExternalResource(url, type) {
    return new Promise((resolve, reject) => {
      console.log('Loading:', url); // 添加日志便于调试
      let tag;
      if (type === "css") {
        tag = document.createElement("link");
        tag.rel = "stylesheet";
        tag.href = url;
      } else if (type === "js") {
        tag = document.createElement("script");
        tag.src = url;
      }
      if (tag) {
        tag.onload = () => {
          console.log('Loaded:', url);
          resolve(url);
        };
        tag.onerror = (e) => {
          console.error('Failed to load:', url, e);
          reject(url);
        };
        document.head.appendChild(tag);
      }
    });
  }
</script>
