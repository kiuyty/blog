{{- /* æ·»åŠ Live2Dçœ‹æ¿å¨˜ - ç»ˆæå¼ºåˆ¶ä¿®å¤ç‰ˆ */ -}}
<script>
  (function() {
    // é…ç½®
    const cdnPath = "https://cdn.jsdelivr.net/gh/kiuyty/live2d@main";
    const config = {
      path: {
        homePath: "/",
        modelPath: cdnPath + "/Resources/",
        cssPath: cdnPath + "/css/waifu.css",
        tipsJsonPath: cdnPath + "/Resources/waifu-tips.json",
        tipsJsPath: cdnPath + "/js/waifu-tips.js",
        live2dCorePath: cdnPath + "/Core/live2dcubismcore.js",
        live2dSdkPath: cdnPath + "/js/live2d-sdk.js"
      },
      tools: ["hitokoto", "asteroids", "express", "switch-model", "switch-texture", "photo", "info", "quit"],
      drag: { enable: true, direction: ["x", "y"] },
      switchType: "order"
    };

    console.log('Live2D ç»ˆæä¿®å¤ç‰ˆå¯åŠ¨', cdnPath);

    if (screen.width < 768) {
      console.log('ç§»åŠ¨ç«¯ä¸æ˜¾ç¤º');
      return;
    }

    // åŠ è½½æ‰€æœ‰èµ„æº
    Promise.all([
      loadCSS(config.path.cssPath),
      loadScript(config.path.live2dCorePath),
      loadScript(config.path.live2dSdkPath),
      loadScript(config.path.tipsJsPath).then(() => {
        console.log('waifu-tips.js å·²åŠ è½½ï¼Œå‡†å¤‡å¼ºåˆ¶ä¿®è¡¥...');
        return new Promise(resolve => setTimeout(resolve, 300));
      })
    ]).then(() => {
      console.log('æ‰€æœ‰èµ„æºå°±ç»ªï¼Œæ‰§è¡Œå¼ºåˆ¶ä¿®è¡¥...');
      
      // ========== å¼ºåˆ¶ä¿®è¡¥æ ¸å¿ƒ ==========
      // 1. é¢„åŠ è½½æ¨¡å‹æ•°æ®
      return fetch(config.path.modelPath + 'model_list.json')
        .then(r => r.json())
        .then(modelData => {
          console.log('æ¨¡å‹æ•°æ®å·²åŠ è½½:', modelData);
          
          // 2. å¼ºåˆ¶æ›¿æ¢å¯èƒ½å‡ºé—®é¢˜çš„å…¨å±€å‡½æ•°
          if (typeof window.loadModelList === 'function') {
            const original = window.loadModelList;
            window.loadModelList = async function() {
              console.log('æ‹¦æˆª loadModelList');
              return { models: modelData };
            };
          }
          
          // 3. æŸ¥æ‰¾å¹¶æ›¿æ¢ live2d å¯¹è±¡çš„æ–¹æ³•
          if (window.live2d) {
            const originalLoadModel = window.live2d.loadModel;
            window.live2d.loadModel = function(path) {
              console.log('æ‹¦æˆª live2d.loadModel:', path);
              // ç¡®ä¿è·¯å¾„æ­£ç¡®
              if (path && !path.includes('lafei')) {
                path = config.path.modelPath + 'model/lafei/lafei.model3.json';
              }
              return originalLoadModel.call(this, path);
            };
          }
          
          // 4. å¦‚æœå­˜åœ¨ ModelManagerï¼Œç›´æ¥æ›¿æ¢
          if (window.ModelManager) {
            window.ModelManager.prototype.getModelList = function() {
              return { models: modelData };
            };
          }
          
          // 5. æœ€åè°ƒç”¨åŸå§‹ initWidgetï¼Œä½†ä¼ å…¥å®Œæ•´æ•°æ®
          if (typeof window.initWidget === 'function') {
            console.log('è°ƒç”¨ initWidget');
            window.initWidget({
              waifuPath: config.path.tipsJsonPath,
              cdnPath: config.path.modelPath,
              tools: config.tools,
              dragEnable: config.drag.enable,
              dragDirection: config.drag.direction,
              switchType: config.switchType,
              modelList: { models: modelData }
            });
          }
          
          // 6. æ‰‹åŠ¨è®¾ç½®æ¨¡å‹è·¯å¾„å¹¶åŠ è½½
          setTimeout(() => {
            if (window.live2d) {
              window.live2d.init(config.path.modelPath + 'model/');
              window.live2d.loadModel(config.path.modelPath + 'model/lafei/lafei.model3.json');
              console.log('æ‰‹åŠ¨è§¦å‘æ¨¡å‹åŠ è½½');
            }
          }, 500);
          
          console.log('ğŸ‰ å¼ºåˆ¶ä¿®è¡¥å®Œæˆ');
        });
    }).catch(e => console.error('åˆå§‹åŒ–å¤±è´¥:', e));

    // è¾…åŠ©å‡½æ•°
    function loadCSS(url) {
      return new Promise((resolve, reject) => {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = url;
        link.onload = () => resolve(url);
        link.onerror = reject;
        document.head.appendChild(link);
      });
    }

    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        script.onload = () => resolve(url);
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
  })();
</script>

<!-- åŸºç¡€æ ·å¼ -->
<style>
  #waifu { right: 0; bottom: 0; left: auto; }
  #waifu-toggle { right: 5px; left: auto; }
</style>
