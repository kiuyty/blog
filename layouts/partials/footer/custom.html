{{- /* æ·»åŠ Live2Dçœ‹æ¿å¨˜ - å®Œæ•´æœ€ç»ˆä¿®å¤ç‰ˆ */ -}}
<script>
  // ä½¿ç”¨ä½ çš„ GitHub ä»“åº“ (jsDelivr CDN)
  const cdnPath = "https://cdn.jsdelivr.net/gh/kiuyty/live2d@main";
  
  const config = {
    path: {
      homePath: "/",
      // æ¨¡å‹æ–‡ä»¶è·¯å¾„ - å¿…é¡»æŒ‡å‘åŒ…å« model_list.json çš„ç›®å½•
      modelPath: cdnPath + "/Resources/",
      // CSSæ ·å¼æ–‡ä»¶
      cssPath: cdnPath + "/css/waifu.css",
      // æç¤ºè¯­JSONæ–‡ä»¶
      tipsJsonPath: cdnPath + "/Resources/waifu-tips.json",
      // æç¤ºè¯­JSæ–‡ä»¶ (æ ¸å¿ƒé€»è¾‘)
      tipsJsPath: cdnPath + "/js/waifu-tips.js",
      // Live2Dæ ¸å¿ƒå¼•æ“
      live2dCorePath: cdnPath + "/Core/live2dcubismcore.js",
      // Live2D SDK
      live2dSdkPath: cdnPath + "/js/live2d-sdk.js"
    },
    // å·¥å…·æ æŒ‰é’® - å¯æŒ‰éœ€è°ƒæ•´é¡ºåºæˆ–å¢å‡
    tools: ["hitokoto", "asteroids", "express", "switch-model", "switch-texture", "photo", "info", "quit"],
    // æ‹–æ‹½è®¾ç½®
    drag: {
      enable: true,           // æ˜¯å¦å¯ç”¨æ‹–æ‹½
      direction: ["x", "y"]    // å¯æ‹–æ‹½æ–¹å‘: x-æ°´å¹³, y-å‚ç›´
    },
    // æ¨¡å‹åˆ‡æ¢æ–¹å¼: order(é¡ºåº) æˆ– random(éšæœº)
    switchType: "order"
  }

  console.log('Live2D åŠ è½½ä¸­...', cdnPath);
  console.log('æ¨¡å‹åˆ—è¡¨è·¯å¾„:', config.path.modelPath + 'model_list.json');

  // åªåœ¨æ¡Œé¢ç«¯æ˜¾ç¤º (å±å¹•å®½åº¦ >= 768px)
  if (screen.width >= 768) {
    // å¹¶è¡ŒåŠ è½½æ‰€æœ‰èµ„æº
    Promise.all([
      loadExternalResource(config.path.cssPath, "css"),
      loadExternalResource(config.path.live2dCorePath, "js"),
      loadExternalResource(config.path.live2dSdkPath, "js"),
      loadExternalResource(config.path.tipsJsPath, "js")
    ]).then(() => {
      console.log('æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆï¼Œæ­£åœ¨æ·±åº¦ä¿®è¡¥ waifu-tips.js...');
      
      // ç»™ waifu-tips.js ä¸€ç‚¹æ—¶é—´å®Œæˆåˆå§‹å®šä¹‰
      setTimeout(() => {
        // ==================== æ·±åº¦ä¿®è¡¥å¼€å§‹ ====================
        console.log('å¼€å§‹æ‰§è¡Œæ·±åº¦ä¿®è¡¥...');
        
        // 1. è·å–å¹¶è½¬æ¢æ¨¡å‹æ•°æ®
        fetch(config.path.modelPath + 'model_list.json')
          .then(response => {
            console.log('model_list.json çŠ¶æ€:', response.status);
            return response.json();
          })
          .then(rawModelData => {
            console.log('åŸå§‹æ¨¡å‹æ•°æ®:', rawModelData);
            
            // 2. æ£€æŸ¥ ModelLoader ç±»æ˜¯å¦å­˜åœ¨å¹¶ä¿®è¡¥
            if (typeof ModelLoader === 'function') {
              console.log('âœ… æ‰¾åˆ° ModelLoader ç±»ï¼Œæ­£åœ¨ä¿®è¡¥å…¶åŸå‹æ–¹æ³•...');
              
              // ä¿å­˜åŸå§‹çš„ loadModelList æ–¹æ³•
              const originalLoadModelList = ModelLoader.prototype.loadModelList;
              
              // è¦†ç›– loadModelList æ–¹æ³• - è¿™æ˜¯æœ€å…³é”®çš„éƒ¨åˆ†
              ModelLoader.prototype.loadModelList = async function() {
                console.log('ã€ä¿®è¡¥ã€‘loadModelList è¢«è°ƒç”¨ï¼Œæ­£åœ¨åŠ è½½æ¨¡å‹åˆ—è¡¨...');
                try {
                  // åˆ›å»ºç¬¦åˆå†…éƒ¨æœŸæœ›çš„æ•°æ®ç»“æ„
                  // waifu-tips.js å†…éƒ¨æœŸæœ› this.modelList.models å­˜åœ¨
                  this.modelList = { models: rawModelData };
                  console.log('ã€ä¿®è¡¥ã€‘æ¨¡å‹åˆ—è¡¨å·²è®¾ç½®ä¸º:', this.modelList);
                  return this.modelList;
                } catch (error) {
                  console.error('ã€ä¿®è¡¥ã€‘è®¾ç½®æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                  this.modelList = { models: [] };
                  return this.modelList;
                }
              };
              
              // ä¿å­˜åŸå§‹çš„ loadModel æ–¹æ³•ç”¨äºè°ƒè¯•
              const originalLoadModel = ModelLoader.prototype.loadModel;
              ModelLoader.prototype.loadModel = async function(modelId, textureId, message) {
                console.log(`ã€ä¿®è¡¥ã€‘loadModel è¢«è°ƒç”¨: modelId=${modelId}, textureId=${textureId}`);
                
                // ç¡®ä¿ modelList å·²è®¾ç½®
                if (!this.modelList || !this.modelList.models) {
                  console.log('ã€ä¿®è¡¥ã€‘modelList æœªè®¾ç½®ï¼Œæ­£åœ¨è®¾ç½®...');
                  this.modelList = { models: rawModelData };
                }
                
                // è°ƒç”¨åŸå§‹æ–¹æ³•
                return originalLoadModel.call(this, modelId, textureId, message);
              };
              
              console.log('âœ… ModelLoader åŸå‹æ–¹æ³•ä¿®è¡¥å®Œæˆ');
              
              // 3. ä¿®è¡¥ initWidget å‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              if (typeof window.initWidget === 'function') {
                const originalInitWidget = window.initWidget;
                window.initWidget = function(options) {
                  console.log('ã€ä¿®è¡¥ã€‘initWidget è¢«è°ƒç”¨ï¼ŒåŸå§‹é€‰é¡¹:', options);
                  
                  // ç¡®ä¿æ¨¡å‹æ•°æ®è¢«æ­£ç¡®ä¼ é€’
                  if (!options.modelList) {
                    options.modelList = { models: rawModelData };
                  }
                  
                  // è°ƒç”¨åŸå§‹ initWidget
                  originalInitWidget(options);
                  console.log('ã€ä¿®è¡¥ã€‘initWidget è°ƒç”¨å®Œæˆ');
                };
                console.log('âœ… initWidget ä¿®è¡¥å®Œæˆ');
              }
              
              // 4. æ‰‹åŠ¨è§¦å‘æ¨¡å‹åŠ è½½
              console.log('å‡†å¤‡æ‰‹åŠ¨åŠ è½½æ¨¡å‹...');
              
              // å°è¯•è·å– ModelLoader å®ä¾‹
              // æœ‰äº›å®ç°ä¼šå°†å®ä¾‹æŒ‚åœ¨ window ä¸Š
              if (window.modelLoader) {
                window.modelLoader.loadModel(0, 0, 'æ¬¢è¿æ¥åˆ°åšå®¢ï¼');
              } else {
                // å¦‚æœæ²¡æœ‰ç›´æ¥å®ä¾‹ï¼Œå°è¯•åˆ›å»ºå¹¶åˆå§‹åŒ–
                try {
                  // æ£€æŸ¥ live2d å¯¹è±¡æ˜¯å¦å­˜åœ¨
                  if (window.live2d) {
                    console.log('æ‰¾åˆ° live2d å¯¹è±¡ï¼Œå°è¯•åˆå§‹åŒ–...');
                    
                    // è®¾ç½®æ¨¡å‹è·¯å¾„
                    window.live2d.init(config.path.modelPath + 'model/');
                    
                    // åŠ è½½ç¬¬ä¸€ä¸ªæ¨¡å‹
                    setTimeout(() => {
                      if (window.live2d.loadModel) {
                        // æ„å»ºæ¨¡å‹å®Œæ•´è·¯å¾„
                        const modelPath = config.path.modelPath + 'model/lafei/lafei.model3.json';
                        console.log('åŠ è½½æ¨¡å‹:', modelPath);
                        window.live2d.loadModel(modelPath);
                      }
                    }, 500);
                  }
                } catch (e) {
                  console.error('æ‰‹åŠ¨åŠ è½½æ¨¡å‹å¤±è´¥:', e);
                }
              }
              
            } else {
              console.warn('âš ï¸ æœªæ‰¾åˆ° ModelLoader ç±»ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ');
              
              // å¤‡é€‰æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨åŸå§‹ initWidget
              if (typeof window.initWidget === 'function') {
                window.initWidget({
                  waifuPath: config.path.tipsJsonPath,
                  cdnPath: config.path.modelPath,
                  tools: config.tools,
                  dragEnable: config.drag.enable,
                  dragDirection: config.drag.direction,
                  switchType: config.switchType,
                  modelList: { models: rawModelData }
                });
                console.log('âœ… ä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆåˆå§‹åŒ–å®Œæˆ');
              }
            }
            
            console.log('ğŸ‰ æ‰€æœ‰ä¿®è¡¥å·¥ä½œå®Œæˆï¼');
          })
          .catch(error => {
            console.error('âŒ è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
          });
        
        // ==================== æ·±åº¦ä¿®è¡¥ç»“æŸ ====================
        
      }, 800); // ç»™ waifu-tips.js 800ms å®Œæˆåˆå§‹å®šä¹‰
      
    }).catch(error => {
      console.error('Live2D èµ„æºåŠ è½½å¤±è´¥:', error);
    });
  } else {
    console.log('ç§»åŠ¨ç«¯ä¸æ˜¾ç¤º Live2D');
  }

  /**
   * å¼‚æ­¥åŠ è½½å¤–éƒ¨èµ„æº (CSS æˆ– JS)
   * @param {string} url èµ„æºURL
   * @param {string} type èµ„æºç±»å‹: "css" æˆ– "js"
   * @returns {Promise}
   */
  function loadExternalResource(url, type) {
    return new Promise((resolve, reject) => {
      console.log('åŠ è½½:', url);
      let tag;
      
      if (type === "css") {
        tag = document.createElement("link");
        tag.rel = "stylesheet";
        tag.href = url;
      } else if (type === "js") {
        tag = document.createElement("script");
        tag.src = url;
      } else {
        reject(new Error(`ä¸æ”¯æŒçš„ç±»å‹: ${type}`));
        return;
      }
      
      if (tag) {
        tag.onload = () => {
          console.log('âœ… åŠ è½½æˆåŠŸ:', url);
          resolve(url);
        };
        tag.onerror = (e) => {
          console.error('âŒ åŠ è½½å¤±è´¥:', url, e);
          reject(url);
        };
        document.head.appendChild(tag);
      }
    });
  }
</script>

<!-- æ·»åŠ ä¸€äº›è‡ªå®šä¹‰æ ·å¼æ¥è°ƒæ•´çœ‹æ¿å¨˜ä½ç½®ï¼ˆå¯é€‰ï¼‰ -->
<style>
  #waifu {
    right: 0 !important;
    bottom: 0 !important;
    left: auto !important;
  }
  #waifu-toggle {
    right: 5px !important;
    left: auto !important;
  }
</style>
